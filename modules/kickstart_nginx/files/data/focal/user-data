#cloud-config
autoinstall:
  version: 1
  locale: en_UK
  keyboard:
    layout: en
    variant: uk
  network:
    network:
      version: 2
      ethernets:
        ens18:
          dhcp4: true
  storage:
    layout:
      name: lvm
  identity:
    hostname: focal-template
    username: ubuntu
    password: $6$rounds=4096$8dkK1P/oE$2DGKKt0wLlTVJ7USY.0jN9du8FetmEr51yjPyeiR.zKE3DGFcitNL/nF1l62BLJNR87lQZixObuXYny.Mf17K1
  apt:
    sources:
        hashicorp.list:
            source: "deb [arch=amd64] https://apt.releases.hashicorp.com $RELEASE main"
            keyid: E8A0 32E0 94D8 EB4E A189  D270 DA41 8C88 A321 9F7B
        puppet6.list:
            source: "deb http://apt.puppetlabs.com $RELEASE puppet6"
            keyid: 6F6B 1550 9CF8 E59E 6E46  9F32 7F43 8280 EF8D 349F
  packages:
  - curl
  - dmidecode
  - git
  - screen
  - vim-nox
  - qemu-guest-agent

  ssh:
    install-server: yes
  user-data:
    disable_root: false
  write_files:
  - path: /etc/puppet_branch
    content: |
      master
  - path: /etc/bootstrap
  - path: /usr/local/bootstrap.sh
    owner: root:root
    permissions: '0744'
    content: |
      #! /usr/bin/env bash

      if [ -f /etc/bootstrap ]; then
          apt update
          apt install puppet6-release puppet-agent vault

          echo "Deleting setup user" | tee -a /var/log/bootstrap.log
          userdel ubuntu
          rm -rf /home/ubuntu
          sudo sed -i '/^ubuntu/d' /etc/sudoers


          echo "Regenerating ssh host keys" | tee -a /var/log/bootstrap.log
          rm -v /etc/ssh/ssh_host* 2>&1 | tee -a /var/log/bootstrap.log
          dpkg-reconfigure openssh-server 2>&1 | tee -a /var/log/bootstrap.log
          service ssh restart 2>&1 | tee -a /var/log/bootstrap.log


          echo "Starting initial puppet run ..." | tee -a /var/log/bootstrap.log
          git clone https://github.com/gentoomaniac/puppet.git /tmp/puppet 2>&1 | tee -a /var/log/bootstrap.log
          sed -i 's#confdir=/var/lib/puppet-repo#confdir=/tmp/puppet#' /tmp/puppet/puppet.conf 2>&1 | tee -a /var/log/bootstrap.log

          /opt/puppetlabs/puppet/bin/puppet apply --config /tmp/puppet/puppet.conf -vvvt --modulepath=/tmp/puppet/modules/ /tmp/puppet/manifests/site.pp 2>&1 | tee -a /var/log/bootstrap.log


          echo "Updating the system ..." | tee -a /var/log/bootstrap.log
          apt-get update 2>&1 | tee -a /var/log/bootstrap.log
          apt-get upgrade -y 2>&1 | tee -a /var/log/bootstrap.log

          echo "Init complete" | tee -a /var/log/bootstrap.log
          systemctl disable bootstrap
          rm /etc/bootstrap /etc/systemd/system/bootstrap.service
          reboot
      fi
  - path: /etc/systemd/system/bootstrap.service
    owner: root:root
    permissions: '0644'
    content: |
      [Unit]
      Description=Boostrap Service
      ConditionPathExists=/etc/bootstrap
      [Service]
      Type=forking
      ExecStart=/usr/local/bin/bootstrap.sh
      TimeoutSec=0
      StandardOutput=tty
      RemainAfterExit=yes
      SysVStartPriority=99

      [Install]
      WantedBy=multi-user.target

  package_update: true
  package_upgrade: true
  late-commands:
    - "systemctl enable bootstrap"

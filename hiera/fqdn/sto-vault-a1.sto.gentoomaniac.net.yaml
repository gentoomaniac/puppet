---
classes:
  - docker
  - docker::run_instance
  - vault

ressources:
  file:
    "/srv":
      ensure: directory
    "/srv/traefik":
      ensure: directory
      require: File[/srv]
    "/srv/traefik/static.toml":
      ensure: present
      content: |
        [http.services]
          [http.services.vault.loadBalancer]
            [[http.services.vault.loadBalancer.servers]]
                url = "http://localhost:8200"
        [http.routers]
          [http.routers.vault]
            rule = "Host(`vault.srv.gentoomaniac.net`)"
            service = "vault"
            entryPoints = ["websecure"]
            middlewares = ["local-only-whitelist"]
            [http.routers.vault.tls]
        [http.middlewares]
          [http.middlewares.local-only-whitelist]
              [http.middlewares.local-only-whitelist.ipwhitelist]
                  sourcerange = ["10.1.1.0/24","10.1.15.0/24"]
      require: File[/srv/traefik]

docker::docker_users:
  - marco


docker::run_instance::instance:
  traefik:
    image: traefik:v2.2
    command: >
      --api.insecure=true
      --entrypoints.websecure.address=:443
      --serverstransport.insecureskipverify=true
      --providers.file.directory=/conf
      --providers.file.watch=true
    dns:
      - 10.1.1.52
      - 10.1.1.53
    env:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Berlin
    expose:
      - 6789/tcp
    extra_parameters:
      - --restart=unless-stopped
    ports:
      - 443:443/tcp
      - 8080:8080/tcp
    pull_on_start: true
    require:
      - Class[docker]
      - File[/srv/traefik/static.toml]
    volumes:
      - /srv/traefik:/conf:ro

vault::storage:
  file:
    path: /tmp

vault::listener:
  - tcp:
      address: 127.0.0.1:8200
      tls_disable: 1

vault::default_lease_ttl: 720h

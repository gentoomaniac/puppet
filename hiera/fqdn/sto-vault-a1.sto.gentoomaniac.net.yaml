---
classes:
  - docker
  - docker::networks
  - docker::run_instance
  - secrets_host

ressources:
  file:
    "/srv":
      ensure: directory
    "/srv/vault":
      ensure: directory
      require: File[/srv]
    "/srv/vault/data":
      ensure: directory
      owner: 100
      group: 1000
      mode: "0770"
      require: File[/srv/vault]
    "/srv/vault/conf":
      ensure: directory
      require: File[/srv/vault]
    "/srv/vault/conf/config.hcl":
      ensure: present
      content: |
        isable_cache = true
        disable_mlock = true

        ui = true

        storage "file" {
          path = "/data"
        }

        default_lease_ttl = "720h"

docker::docker_users:
  - marco

docker::networks::networks:
  web:
    ensure: 'present'

docker::run_instance::instance:
  traefik:
    image: traefik:v2.2
    command: >
      --api.insecure=true
      --entrypoints.websecure.address=:443
      --serverstransport.insecureskipverify=true
      --providers.docker
      --providers.docker.exposedbydefault=false
    dns:
      - 10.1.1.52
      - 10.1.1.53
    env:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Berlin  
    extra_parameters:
      - --restart=unless-stopped
    net:
      - web
    ports:
      - 443:443/tcp
      - 8080:8080/tcp
    pull_on_start: true
    require:
      - Class[docker]
      - Docker_network[web]
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
  vault:
    image: vault:latest
    dns:
      - 10.1.1.52
      - 10.1.1.53
    expose:
      - 8200/tcp
    extra_parameters:
      - --restart=unless-stopped
      - --cap-add=IPC_LOCK
    labels:
      - "'traefik.enable=true'"
      - "'traefik.http.routers.vault.rule=Host(`vault.srv.gentoomaniac.net`)'"
      - "'traefik.http.routers.vault.entrypoints=websecure'"
      - "'traefik.http.routers.vault.tls=true'"
      - "'traefik.http.middlewares.vault-whitelist.ipwhitelist.sourcerange=10.1.1.0/24,10.1.15.0/24'"
      - "'traefik.http.routers.vault.middlewares=vault-whitelist'"
    net:
      - web
    pull_on_start: true
    require:
      - Class[docker]
      - Docker_network[web]
      - File[/srv/vault/conf/config.hcl]
      - File[/srv/vault/data]
    volumes:
      - /srv/vault/conf:/vault/config
      - /srv/vault/data:/data

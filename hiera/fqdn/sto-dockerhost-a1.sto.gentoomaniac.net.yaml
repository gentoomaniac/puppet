---
classes:
  - logstash_docker
  - tftpd
  - kickstart_nginx
  - ioquake3
  - docker::volumes
  - docker::run_instance

traefik::ports:
  - 9200:9200/tcp

ressources:
  sysctl:
    vm.max_map_count:
      value: 262144
  file:
    /srv/elasticsearch:
      ensure: directory
      require: File[/srv]
    /srv/grafana:
      owner: 1000
      group: 1000
      ensure: directory
    /srv/nzbget:
      ensure: directory
    /srv/nzbget/config:
      ensure: directory
      owner: 1000
      group: 1000
      require: File[/srv/nzbget]
    /srv/nzbget/downloads:
      ensure: directory
      owner: 1000
      group: 1000
      require: File[/srv/nzbget]
    /srv/portainer:
      ensure: directory
      require: File[/srv]
    /srv/quassel-core:
      ensure: directory
      require: File[/srv]
    /srv/radarr:
      ensure: directory
      require: File[/srv]
    /srv/radarr-kids:
      ensure: directory
      require: File[/srv]
    /srv/registry:
      ensure: directory
      require: File[/srv]
    /srv/sonarr:
      ensure: directory
      require: File[/srv]
    /srv/tautulli:
      ensure: directory
      require: File[/srv]

netplan::version: 2
netplan::renderer: networkd
netplan::ethernets:
  enp0s25:
    dhcp4: no
    addresses:
      - 10.1.1.3/24
    nameservers:
      search: [gentoomaniac.net]
      addresses: [10.1.1.52, 10.1.1.53]
    routes:
      - to: 0.0.0.0/0
        via: 10.1.1.1
        metric: 10

docker::volumes::volumes:
  nfs_movies:
    ensure: present
    driver: local
    options:
      - - type=nfs
        - o=addr=10.1.1.5,nolock,soft,bg,tcp,intr,rsize=8192,wsize=8192,noatime,rw
        - device=:/mnt/movies/movies
  nfs_kids_movies:
    ensure: present
    driver: local
    options:
      - - type=nfs
        - o=addr=10.1.1.5,nolock,soft,bg,tcp,intr,rsize=8192,wsize=8192,noatime,rw
        - device=:/mnt/tank0/kids_movies
  nfs_shows:
    ensure: present
    driver: local
    options:
      - - type=nfs
        - o=addr=10.1.1.5,nolock,soft,bg,tcp,intr,rsize=8192,wsize=8192,noatime,rw
        - device=:/mnt/tank3/shows
  nfs_kids_shows:
    ensure: present
    driver: local
    options:
      - - type=nfs
        - o=addr=10.1.1.5,nolock,soft,bg,tcp,intr,rsize=8192,wsize=8192,noatime,rw
        - device=:/mnt/tank0/kids_shows
  nfs_kids_shows_se:
    ensure: present
    driver: local
    options:
      - - type=nfs
        - o=addr=10.1.1.5,nolock,soft,bg,tcp,intr,rsize=8192,wsize=8192,noatime,rw
        - device=:/mnt/tank0/kids_shows_se
  nfs_sd_old:
    ensure: present
    driver: local
    options:
      - - type=nfs
        - o=addr=10.1.1.5,nolock,soft,bg,tcp,intr,rsize=8192,wsize=8192,noatime,rw
        - device=:/mnt/tank3/sd_old

docker::run_instance::instance:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.4.0
    dns:
      - 10.1.1.52
      - 10.1.1.53
    env:
      - node.name=es01
      - cluster.initial_master_nodes=es01
      - cluster.name=docker-cluster
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms2g -Xmx2g"
    expose:
      - 9200/tcp
    extra_parameters:
      - --restart=unless-stopped
      - --ulimit memlock=-1:-1
    labels:
      - "'traefik.enable=true'"
      - "'traefik.http.routers.elasticsearch-http.rule=Host(`elasticsearch.srv.gentoomaniac.net`)'"
      - "'traefik.http.routers.elasticsearch-http.entrypoints=web'"
      - "'traefik.http.routers.elasticsearch-http.middlewares=es-redirect-to-https'"
      - "'traefik.http.middlewares.es-redirect-to-https.redirectscheme.scheme=https'"
      - "'traefik.http.middlewares.es-redirect-to-https.redirectscheme.port=9200'"
      - "'traefik.http.routers.elasticsearch.rule=Host(`elasticsearch.srv.gentoomaniac.net`)'"
      - "'traefik.http.routers.elasticsearch.entrypoints=elasticsearch'"
      - "'traefik.http.routers.elasticsearch.tls=true'"
      - "'traefik.http.middlewares.elasticsearch-whitelist.ipwhitelist.sourcerange=10.1.1.0/24,10.1.15.0/24,172.17.0.0/24'"
      - "'traefik.http.routers.elasticsearch.middlewares=elasticsearch-whitelist'"
    net:
      - web
    pull_on_start: true
    volumes:
      - /srv/elasticsearch:/usr/share/elasticsearch/data
    require:
      - Class[docker]
      - File[/srv/elasticsearch]
  grafana:
    image: grafana/grafana:latest
    dns:
      - 10.1.1.52
      - 10.1.1.53
    env:
      - GF_SERVER_ROOT_URL=https://grafana.srv.gentoomaniac.net
      # - GF_SECURITY_ADMIN_PASSWORD=
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource
    expose:
      - 3000/tcp
    extra_parameters:
      - --restart=unless-stopped
    labels:
      - "'traefik.enable=true'"
      - "'traefik.http.routers.grafana.rule=Host(`grafana.srv.gentoomaniac.net`)'"
      - "'traefik.http.routers.grafana.entrypoints=websecure'"
      - "'traefik.http.routers.grafana.tls=true'"
      - "'traefik.http.middlewares.grafana-whitelist.ipwhitelist.sourcerange=10.1.1.0/24,10.1.15.0/24'"
      - "'traefik.http.routers.grafana.middlewares=grafana-whitelist'"
    net:
      - web
    pull_on_start: true
    username: 1000:1000
    volumes:
      - /srv/grafana:/var/lib/grafana
    require:
      - Class[docker]
      - File[/srv/grafana]
  nzbget:
    image: linuxserver/nzbget:latest
    dns:
      - 10.1.1.52
      - 10.1.1.53
    env:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Berlin
    expose:
      - 6789/tcp
    extra_parameters:
      - --restart=unless-stopped
    labels:
      - "'traefik.enable=true'"
      - "'traefik.http.routers.nzbget.rule=Host(`nzbget.srv.gentoomaniac.net`)'"
      - "'traefik.http.routers.nzbget.entrypoints=websecure'"
      - "'traefik.http.routers.nzbget.tls=true'"
      - "'traefik.http.middlewares.nzbget-whitelist.ipwhitelist.sourcerange=10.1.1.0/24,10.1.15.0/24,172.17.0.0/24'"
      - "'traefik.http.routers.nzbget.middlewares=nzbget-whitelist'"
    net:
      - web
    pull_on_start: true
    volumes:
      - /srv/nzbget/config:/config
      - /srv/nzbget/downloads:/downloads
      - nfs_movies:/movies
      - nfs_shows:/shows
      - nfs_kids_movies:/kids_movies
      - nfs_kids_shows:/kids_shows
    require:
      - Class[docker]
      - Docker_volume[nfs_movies]
      - Docker_volume[nfs_shows]
      - Docker_volume[nfs_kids_movies]
      - Docker_volume[nfs_kids_shows]
      - File[/srv/nzbget/config]
      - File[/srv/nzbget/downloads]
  portainer:
    image: portainer/portainer:latest
    dns:
      - 10.1.1.52
      - 10.1.1.53
    expose:
      - 9000/tcp
    extra_parameters:
      - --restart=unless-stopped
    labels:
      - "'traefik.enable=true'"
      - "'traefik.http.routers.portainer.rule=Host(`portainer.srv.gentoomaniac.net`)'"
      - "'traefik.http.routers.portainer.entrypoints=websecure'"
      - "'traefik.http.routers.portainer.tls=true'"
      - "'traefik.http.middlewares.portainer-whitelist.ipwhitelist.sourcerange=10.1.1.0/24,10.1.15.0/24'"
      - "'traefik.http.routers.portainer.middlewares=portainer-whitelist'"
    net:
      - web
    pull_on_start: true
    volumes:
      - /srv/portainer:/data
      - /var/run/docker.sock:/var/run/docker.sock
    require:
      - Class[docker]
      - File[/srv/portainer]
  quassel-core:
    image: linuxserver/quassel-core:latest
    dns:
      - 10.1.1.52
      - 10.1.1.53
    env:
      - PUID=1000
      - PGID=1000
    ports:
      - 4242:4242/tcp
    extra_parameters:
      - --restart=unless-stopped
    labels:
      - "'traefik.enable=false'"
    pull_on_start: true
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /srv/quassel-core:/config
    require:
      - Class[docker]
      - File[/srv/quassel-core]
  radarr:
    image: linuxserver/radarr:latest
    dns:
      - 10.1.1.52
      - 10.1.1.53
    env:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Berlin
      - UMASK_SET=022
    expose:
      - 7878/tcp
    extra_parameters:
      - --restart=unless-stopped
    labels:
      - "'traefik.enable=true'"
      - "'traefik.http.routers.radarr.rule=Host(`radarr.srv.gentoomaniac.net`)'"
      - "'traefik.http.routers.radarr.entrypoints=websecure'"
      - "'traefik.http.routers.radarr.tls=true'"
      - "'traefik.http.middlewares.radarr-whitelist.ipwhitelist.sourcerange=10.1.1.0/24,10.1.15.0/24'"
      - "'traefik.http.routers.radarr.middlewares=radarr-whitelist'"
    net:
      - web
    pull_on_start: true
    volumes:
      - /srv/radarr:/config
      - nfs_movies:/movies
    require:
      - Class[docker]
      - File[/srv/radarr]
  radarr-kids:
    image: linuxserver/radarr:latest
    dns:
      - 10.1.1.52
      - 10.1.1.53
    env:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Berlin
      - UMASK_SET=022
    expose:
      - 7878/tcp
    extra_parameters:
      - --restart=unless-stopped
    labels:
      - "'traefik.enable=true'"
      - "'traefik.http.routers.radarr-kids.rule=Host(`radarr-kids.srv.gentoomaniac.net`)'"
      - "'traefik.http.routers.radarr-kids.entrypoints=websecure'"
      - "'traefik.http.routers.radarr-kids.tls=true'"
      - "'traefik.http.middlewares.radarr-kids-whitelist.ipwhitelist.sourcerange=10.1.1.0/24,10.1.15.0/24'"
      - "'traefik.http.routers.radarr-kids.middlewares=radarr-kids-whitelist'"
    net:
      - web
    pull_on_start: true
    volumes:
      - /srv/radarr-kids:/config
      - nfs_kids_movies:/kids_movies
    require:
      - Class[docker]
      - File[/srv/radarr-kids]
  registry:
    image: registry:2
    dns:
      - 10.1.1.52
      - 10.1.1.53
    env:
      - REGISTRY_HTTP_ADDR=0.0.0.0:80
    expose:
      - 80/tcp
    extra_parameters:
      - --restart=unless-stopped
    labels:
      - "'traefik.enable=true'"
      - "'traefik.http.routers.registry.rule=Host(`registry.srv.gentoomaniac.net`)'"
      - "'traefik.http.routers.registry.entrypoints=websecure'"
      - "'traefik.http.routers.registry.tls=true'"
      - "'traefik.http.middlewares.registry-whitelist.ipwhitelist.sourcerange=10.1.1.0/24,10.1.15.0/24'"
      - "'traefik.http.routers.registry.middlewares=registry-whitelist'"
    net:
      - web
    pull_on_start: true
    volumes:
      - /srv/registry:/var/lib/registry
    require:
      - Class[docker]
      - File[/srv/registry]
  sonarr:
    image: linuxserver/sonarr:latest
    dns:
      - 10.1.1.52
      - 10.1.1.53
    env:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Berlin
      - UMASK_SET=022
    expose:
      - 8989/tcp
    extra_parameters:
      - --restart=unless-stopped
    labels:
      - "'traefik.enable=true'"
      - "'traefik.http.routers.sonarr.rule=Host(`sonarr.srv.gentoomaniac.net`)'"
      - "'traefik.http.routers.sonarr.entrypoints=websecure'"
      - "'traefik.http.routers.sonarr.tls=true'"
      - "'traefik.http.middlewares.sonarr-whitelist.ipwhitelist.sourcerange=10.1.1.0/24,10.1.15.0/24'"
      - "'traefik.http.routers.sonarr.middlewares=sonarr-whitelist'"
    net:
      - web
    pull_on_start: true
    volumes:
      - /srv/sonarr:/config
      - nfs_shows:/shows
    require:
      - Class[docker]
      - File[/srv/sonarr]
  tautulli:
    image: linuxserver/tautulli:latest
    dns:
      - 10.1.1.52
      - 10.1.1.53
    expose:
      - 8181/tcp
    extra_parameters:
      - --restart=unless-stopped
    labels:
      - "'traefik.enable=true'"
      - "'traefik.http.routers.tautulli.rule=Host(`tautulli.srv.gentoomaniac.net`)'"
      - "'traefik.http.routers.tautulli.entrypoints=websecure'"
      - "'traefik.http.routers.tautulli.tls=true'"
      - "'traefik.http.middlewares.tautulli-whitelist.ipwhitelist.sourcerange=10.1.1.0/24,10.1.15.0/24'"
      - "'traefik.http.routers.tautulli.middlewares=tautulli-whitelist'"
    net:
      - web
    pull_on_start: true
    volumes:
      - /srv/tautulli:/config
    require:
      - Class[docker]
      - File[/srv/tautulli]

kickstart_nginx::labels:
  - "'traefik.enable=true'"
  - "'traefik.http.routers.ksnginx.rule=Host(`ks.srv.gentoomaniac.net`)'"
  - "'traefik.http.routers.ksnginx.entrypoints=websecure'"
  - "'traefik.http.routers.ksnginx.tls=true'"
  - "'traefik.http.middlewares.ksnginx-whitelist.ipwhitelist.sourcerange=10.1.1.0/24,10.1.15.0/24'"
  - "'traefik.http.routers.ksnginx.middlewares=ksnginx-whitelist'"
